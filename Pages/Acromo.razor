@page "/"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@inject PokeAPIService PokeAPI
@inject PokeSpriteService PokeSprite
@inject PokepasteService Pokepaste
@inject TeamParserService TeamParser
@inject TeamAnalysisService TeamAnalysis
@using System.Text.RegularExpressions

<PageTitle>Acromo - Teambuilding Helper</PageTitle>
<link rel="stylesheet" href="css/gen5-theme.css" />

<div class="page-header" style="text-align: center; border: none; background: transparent; padding: 2rem 0;">
    <h1><span style="font-size: 3rem;">üî¨</span> Acromo Teambuilding Helper</h1>
    <p>Analyze your Pokemon team with comprehensive competitive insights</p>
</div>

<details class="gen5-info-box">
    <summary class="gen5-summary">
        <span class="gen5-icon">‚ÑπÔ∏è</span>
        About This Tool
        <span class="gen5-arrow">‚ñº</span>
    </summary>
    <div class="gen5-content">
        <h3>What This Tool Does</h3>
        <p>
            This tool analyzes your Pokemon team in Showdown format and provides comprehensive competitive analysis.
            It displays your team with sprites, evaluates type coverage, detects team archetypes, and checks against
            competitive standards for SV OU (Generation 9 Overused tier).
        </p>
        
        <h3>Analysis Criteria</h3>
        <ul>
            <li><strong>Team Archetypes:</strong> Detects Stall, Semi-Stall, Hyper Offense, or Balanced team compositions</li>
            <li><strong>Type Coverage:</strong> Analyzes which types can hit your team for neutral or super effective damage</li>
            <li><strong>Competitive Checklist:</strong> Evaluates 15+ competitive criteria including:
                <ul>
                    <li>Entry hazards (Stealth Rock, Spikes)</li>
                    <li>Hazard removal (Rapid Spin, Defog)</li>
                    <li>Priority moves and fast Pokemon</li>
                    <li>Status immunity and type resistances</li>
                    <li>Pivoting moves and momentum control</li>
                </ul>
            </li>
        </ul>
        
        <h3>Data Sources</h3>
        <ul>
            <li><strong>PokeAPI:</strong> Pokemon sprites, types, and move data</li>
            <li><strong>Pok√©Sprite:</strong> Item sprites (including Gen 8+ items like Heavy-Duty Boots)</li>
        </ul>
    </div>
</details>

<section class="pokepaste-section">
    <!-- New URL Input Section -->
    <div class="input-section url-input-section">
        <h2>üîó Import from Pokepaste</h2>
        <div class="url-input-container">
            <input 
                type="text" 
                class="form-control gen5-input" 
                @bind="pokepasteUrl" 
                placeholder="https://pokepast.es/..." 
                @onkeyup="@(e => e.Key == "Enter" ? FetchTeamFromUrl() : Task.CompletedTask)" />
            <button class="btn btn-primary" @onclick="FetchTeamFromUrl" disabled="@isLoading">
                <span class="btn-icon">üì•</span> Fetch
            </button>
        </div>
    </div>

    <!-- Collapsible Manual Input Section -->
    <details class="gen5-info-box manual-input-details">
        <summary class="gen5-summary">
            <span class="gen5-icon">üìù</span>
            Or Paste Manually
            <span class="gen5-arrow">‚ñº</span>
        </summary>
        <div class="gen5-content">
            <div class="input-section">
                <textarea 
                    class="team-input" 
                    @bind="teamInput" 
                    placeholder="Paste your Pokemon team here...">
                </textarea>
                <div class="input-controls">
                    <button class="btn btn-primary" @onclick="ParseTeam">
                        <span class="btn-icon">‚ö°</span> Parse Team
                    </button>
                    <button class="btn btn-secondary" @onclick="ClearInput">
                        <span class="btn-icon">üóëÔ∏è</span> Clear
                    </button>
                </div>
            </div>
        </div>
    </details>

    @if (isLoading)
    {
        <div class="loading-container">
            <div class="spinner"></div>
            <p>Loading Pokemon data...</p>
        </div>
    }

    @if (pokemonTeam.Any())
    {
        <div class="output-section">
            <div class="output-header">
                <h2>‚ú® Your Team</h2>
                <button class="btn btn-primary btn-sm" @onclick="CopyTeam">
                    <span class="btn-icon">üìã</span> Copy Team
                </button>
            </div>
            
            <div class="pokemon-grid">
                @foreach (var pokemon in pokemonTeam)
                {
                    <PokemonCard Pokemon="@pokemon" />
                }
            </div>
        </div>
    }

    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger">
            ‚ö†Ô∏è @errorMessage
        </div>
    }
    
    @if (pokemonTeam.Any() && typeAnalysis != null)
    {
        <div class="type-analysis-section">
            <h2>üéØ Type Coverage Analysis</h2>
            
            @if (typeAnalysis.NeutralCoverageTypes.Any())
            {
                <div class="analysis-card">
                    <h3>‚úÖ Neutral Coverage Types</h3>
                    <p class="analysis-description">These types can hit all Pokemon on the team for at least neutral damage:</p>
                    <div class="type-badges">
                        @foreach (var type in typeAnalysis.NeutralCoverageTypes)
                        {
                            <span class="type-badge type-@type.ToLower()">@type</span>
                        }
                    </div>
                </div>
            }
            else
            {
                <div class="analysis-card">
                    <h3>‚úÖ Neutral Coverage Types</h3>
                    <p class="analysis-description">No single type can hit all Pokemon for neutral damage.</p>
                </div>
            }
            
            @if (typeAnalysis.SuperEffectiveCoverageTypes.Any())
            {
                <div class="analysis-card">
                    <h3>‚ö° Super Effective Coverage (2+ Pokemon)</h3>
                    <p class="analysis-description">These types can hit 2 or more Pokemon for super effective damage:</p>
                    @foreach (var coverage in typeAnalysis.SuperEffectiveCoverageTypes)
                    {
                        <div class="coverage-item">
                            <span class="type-badge type-@coverage.Type.ToLower()">@coverage.Type</span>
                            <span class="coverage-count">Hits @coverage.Count Pokemon</span>
                            <div class="affected-pokemon">
                                @foreach (var pokemon in coverage.AffectedPokemon)
                                {
                                    <span class="pokemon-name">@pokemon</span>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="analysis-card">
                    <h3>‚ö° Super Effective Coverage (2+ Pokemon)</h3>
                    <p class="analysis-description">No type can hit 2 or more Pokemon for super effective damage.</p>
                </div>
            }
            
            @if (typeAnalysis.ImmunityNotes.Any())
            {
                <div class="immunity-section">
                    <h3>üõ°Ô∏è Immunity Considerations</h3>
                    @foreach (var note in typeAnalysis.ImmunityNotes)
                    {
                        <div class="immunity-item">
                            <div class="immunity-icon">‚ÑπÔ∏è</div>
                            <div class="immunity-text">@note</div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    
    @if (pokemonTeam.Any() && teamRating != null)
    {
        <div class="team-rating-section">
            <h2>üìä Team Rating</h2>
            
            <div class="archetype-display">
                <h3>Team Archetype</h3>
                <span class="archetype-badge archetype-@teamRating.Archetype.ToLower()">@teamRating.Archetype</span>
                <p class="archetype-description">@teamRating.ArchetypeDescription</p>
                <p class="archetype-warning">‚ö†Ô∏è Note: Archetype assessment may be imprecise and is subject to changes in the future.</p>
            </div>
            
            <div class="rating-checklist">
                <h3>Competitive Checklist</h3>
                <p class="checklist-intro">Evaluation based on SV OU competitive standards:</p>
                
                @foreach (var check in teamRating.CheckResults)
                {
                    <div class="check-item check-@check.Status.ToLower()">
                        <div class="check-header">
                            <span class="check-icon">@GetCheckIcon(check.Status)</span>
                            <span class="check-name">@check.Name</span>
                            <span class="check-status-badge">@check.Status</span>
                        </div>
                        <p class="check-description">@check.Description</p>
                        @if (!string.IsNullOrEmpty(check.Details))
                        {
                            <p class="check-details">@check.Details</p>
                        }
                    </div>
                }
            </div>
            
            <div class="rating-summary">
                <h3>Overall Score</h3>
                <div class="score-display">
                    <div class="score-circle">
                        <span class="score-value">@teamRating.PassedChecks</span>
                        <span class="score-total">/ @teamRating.TotalChecks</span>
                    </div>
                    <div class="score-grade">
                        <span class="grade-letter">@teamRating.Grade</span>
                        <p class="grade-description">@teamRating.GradeDescription</p>
                    </div>
                </div>
            </div>
        </div>
    }
</section>


@code {
    private string teamInput = "";
    private string pokepasteUrl = "";
    private List<PokemonData> pokemonTeam = new();
    private bool isLoading = false;
    private string errorMessage = "";
    private TypeAnalysis? typeAnalysis = null;
    private TeamRating? teamRating = null;

    private string GetCheckIcon(string status)
    {
        return status switch
        {
            CheckStatus.Pass => "‚úÖ",
            CheckStatus.Fail => "‚ùå",
            CheckStatus.Skip => "‚è≠Ô∏è",
            CheckStatus.Warning => "‚ö†Ô∏è",
            _ => "‚ùì"
        };
    }

    private async Task FetchTeamFromUrl()
    {
        if (string.IsNullOrWhiteSpace(pokepasteUrl))
        {
            errorMessage = "Please enter a Pokepaste URL first!";
            return;
        }

        if (!Pokepaste.IsValidPokepasteUrl(pokepasteUrl))
        {
            errorMessage = "Please enter a valid pokepast.es URL!";
            return;
        }

        errorMessage = "";
        isLoading = true;
        pokemonTeam.Clear();

        try
        {
            var teamText = await Pokepaste.FetchTeamFromUrlAsync(pokepasteUrl);
            
            if (!string.IsNullOrWhiteSpace(teamText))
            {
                teamInput = teamText;
                await ParseTeam();
            }
            else
            {
                errorMessage = "Could not extract team data from the URL. Please try pasting manually.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error fetching from URL: {ex.Message}. Please try pasting manually.";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ParseTeam()
    {
        if (string.IsNullOrWhiteSpace(teamInput))
        {
            errorMessage = "Please paste a Pokemon team first!";
            return;
        }

        errorMessage = "";
        isLoading = true;
        pokemonTeam.Clear();

        try
        {
            // Use TeamParserService to parse the team
            pokemonTeam = TeamParser.ParseTeam(teamInput);
            
            // Fetch sprites and data for all pokemon concurrently
            var fetchTasks = pokemonTeam.Select(p => FetchPokemonSprite(p));
            await Task.WhenAll(fetchTasks);
            
            // Calculate type analysis using TeamAnalysisService
            typeAnalysis = TeamAnalysis.AnalyzeCoverage(pokemonTeam);
            
            // Calculate team rating using TeamAnalysisService
            teamRating = TeamAnalysis.RateTeam(pokemonTeam);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error parsing team: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task FetchPokemonSprite(PokemonData pokemon)
    {
        try
        {
            var response = await PokeAPI.GetPokemonDataAsync(pokemon.Name);
            
            if (response?.Sprites?.FrontDefault != null)
            {
                pokemon.SpriteUrl = response.Sprites.FrontDefault;
            }
            
            // Fetch types
            if (response?.Types != null)
            {
                pokemon.Types = response.Types.Select(t => t.Type?.Name ?? "").Where(n => !string.IsNullOrEmpty(n)).ToList();
            }
            
            // Fetch base stats
            if (response?.Stats != null)
            {
                foreach (var stat in response.Stats)
                {
                    switch (stat.Stat?.Name)
                    {
                        case "hp": pokemon.BaseHP = stat.BaseStat; break;
                        case "attack": pokemon.BaseAttack = stat.BaseStat; break;
                        case "defense": pokemon.BaseDefense = stat.BaseStat; break;
                        case "special-attack": pokemon.BaseSpecialAttack = stat.BaseStat; break;
                        case "special-defense": pokemon.BaseSpecialDefense = stat.BaseStat; break;
                        case "speed": pokemon.BaseSpeed = stat.BaseStat; break;
                    }
                }
            }
        }
        catch
        {
            // If sprite fetch fails, leave it empty (will show placeholder)
            pokemon.SpriteUrl = "";
        }
        
        // Fetch item sprite if item exists
        if (!string.IsNullOrEmpty(pokemon.Item))
        {
            await FetchItemSprite(pokemon);
        }
        
        // Fetch move types
        foreach (var move in pokemon.Moves)
        {
            await FetchMoveType(move);
        }
        StateHasChanged(); // Ensure UI updates after fetching
    }
    
    private async Task FetchMoveType(MoveInfo move)
    {
        var moveType = await PokeAPI.GetMoveTypeAsync(move.Name);
        if (moveType != null)
        {
            move.Type = moveType;
        }
    }
    
    private async Task FetchItemSprite(PokemonData pokemon)
    {
        var spriteUrl = await PokeSprite.GetItemSpriteAsync(pokemon.Item);
        pokemon.ItemSpriteUrl = spriteUrl ?? "";
    }

    private async Task CopyTeam()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", teamInput);
            errorMessage = "";
        }
        catch
        {
            errorMessage = "Failed to copy to clipboard. Please copy manually.";
        }
    }

    private void ClearInput()
    {
        teamInput = "";
        pokemonTeam.Clear();
        errorMessage = "";
    }
}
